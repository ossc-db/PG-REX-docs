概要
====

PG-REXの概要
------------

PG-REXは、PostgreSQL15の同期レプリケーションにPacemakerを組み合わせた高可用ソリューションです。PG-REXは以下の特徴を持ち、システムに対して高い信頼性と可用性を提供します。

-   同期レプリケーション

    PG-REXは、PostgreSQL15の同期レプリケーションを使用します。トランザクションは、PrimaryからStandbyに転送が完了するまで成功しません(クライアントに結果を返しません)。PG-REXは、トランザクションのコミットが確定した時点でPrimaryとStandbyの両ノードでトランザクションが完了したことを保証します。つまり、一方が故障してフェイルオーバ等が発生したとしても、コミット済のトランザクションが失われることはありません。PG-REXをシステムに適用することで、単一故障に対してデータが失われないことを保証することができます。

-   自動フェイルオーバ

    PG-REXでは、Pacemakerに同期レプリケーションのPrimaryとStandbyを管理させ、自動フェイルオーバを提供します。Primaryの故障を検知すると、Pacemakerは自動的にStandbyをPrimaryに昇格させ、クライアントがデータベースサービスを継続的に利用できることを保証します。また、Standbyの故障を検知した場合でも、Pacemakerは自動的にPrimaryを単独で稼働させ続け、故障によりデータベースサービスが停止するのを防ぎます。PG-REXをシステムに適用することで、単一故障に対してデータベースサービスのダウンタイムを極小化することができ、高い可用性を保証することができます。

::: {custom-style="page-break"}
　
:::

制約
----

本節では、PG-REXおよびPG-REX運用補助ツール利用時の制約を示します。

### PG-REXの制約

PG-REXは、PacemakerとPostgreSQLの制約を引き継ぎます。それらの制約は、『Pacemaker関連サイト』、『PostgreSQLドキュメント』を参照してください。

PG-REXそのものの制約を以下に示します。ただし、パラメータに関する制約は『[@sec:postgresql.confの編集](#sec:postgresql.confの編集) [postgresql.confの編集](#sec:postgresql.confの編集)』を参照してください。なお、PG-REXでは二重故障時の継続動作を保証しません。

::: {custom-style="First Paragraph"}
　
:::

1. 動作環境の制約
    :   i. 両ノード共にSTONITHが設定されていること。
        i. PG-REXの運用には最低限、以下に示す3つの独立したNWセグメントが必要となる。
            - データベースサービス提供用LAN(以下S-LAN)
            - インターコネクト通信用LAN(以下IC-LAN)
            - データ転送用(以下D-LAN)とIC-LAN用の兼用LAN

            そのため、PG-REXを構築するノードには少なくとも3つのLANポートが必要となる。また、上記の構成でSTONITH用のLAN(以下STONITH-LAN)と運用管理用のLANを他のLANと兼用する場合は、各自の判断で兼用するLANを選択すること。

        i.  PG-REXで制御可能なノード数は2である。

::: {custom-style="page-break"}
　
:::

2. 運用中の制約
    :   i. D-LANの切断やStandbyの停止・クラッシュによりレプリケーションが停止すると、一時的にトランザクションが停止するため、トランザクションの実行時間が長くなる。
        i. コミット発行時に、アプリケーション側に異常終了が返却された場合、トランザクションは以下のいずれかの状態となる。異常終了がPrimaryのクラッシュによるものである場合、フェイルオーバ後にそのトランザクションが見えるかどうかは不定である。

            - PrimaryとStandbyともにトランザクションは確定済
            - Primaryのみトランザクションは確定済。Standbyでは未確定
            - PrimaryとStandbyともにトランザクションは未確定

        i. pg\_cancel\_backend関数[^3]
           またはpg\_terminate\_backend関数[^4]
           をPrimaryで実行すると以下のログが出力されることがある。

           「DETAIL: The transaction has already committed locally, but
           might not have been replicated to the standby.」

           この場合、それらの関数によってキャンセルされたSQLやトランザクションはPrimaryにおいて既にコミットされている状態となる。ただし、StandbyにWALの同期書込みがされている保証はない。

        i. 本マニュアル以外のPacemaker関連のドキュメントに記載されている各操作手順は、PG-REXでは動作保証しない。

        i. 以下の操作を行う場合は、事前に必要な準備を行った上で実行すること[^5]。
           - テーブルスペースの作成:両ノードにテーブルスペースのディレクトリを作成した上で、テーブルスペースを作成する必要がある。
           - 独自に開発したライブラリの登録:両ノードにライブラリを配置した上で、登録する必要がある。
        i. PostgreSQLのバックアップをStandbyで取得する際に、バックアップ中にフェイルオーバが発生した場合、バックアップが正常に取得できない。
        i.  レプリケーション設定はPG-REXが自動的に設定するため、手動で設定を行った場合の動作は保証しない。
            PG-REXが自動的に設定するレプリケーション設定の詳細は『[@sec:postgresql.confの編集](#sec:postgresql.confの編集) [postgresql.confの編集](#sec:postgresql.confの編集)』を参照のこと。

::: {custom-style="page-break"}
　
:::

3. フェイルオーバ動作時の制約
    :   i. フェイルオーバが発生した場合、一時的なデータベースサービスの停止が発生する。そのため、アプリケーション側で接続断に対する後処理を実施する必要がある。
        i. Standbyの起動後、StandbyがPrimaryに追いつく(同期が完了する)までの間にPrimaryが終了した場合、フェイルオーバは行われない。
        i. Standbyでクエリを実行する場合、クエリの読み込み処理とレプリケーションの書き込み処理の競合[^7]によりフェイルオーバ時間が長くなる可能性がある。これは、競合によりレプリケーションの書込み処理がその間停止するためである。

::: {custom-style="First Paragraph"}
　
:::

4. 故障対応時の制約
    :   i. 自動的なフェイルバックをサポートしない。つまり、フェイルオーバ後にpgrex02が単独でPrimaryとして稼働しているときに、旧Primaryのpgrex01をStandbyとして組み込んだ場合でも、自動的にpgrex01がPrimary、pgrex02がStandbyに切り替わることはない。

::: {custom-style="First Paragraph"}
　
:::

5. メンテナンス時の制約
    :   i. フェイルバックまたはスイッチオーバを実行したとき、フェイルオーバ時と同様に一時的なデータベースサービスの停止が発生する。

::: {custom-style="First Paragraph"}
　
:::

### PG-REX運用補助ツールの制約

PG-REX運用補助ツール利用時の制約を以下に示します。

1. pg-rex\_switchoverによるノード切り替えでは、Primaryの停止後からPrimaryの切り替え（新Primaryの起動）が完了するまでの間は一時的にデータベースサービスが停止した状態となる。
2. pg-rex\_switchoverによるノード切り替えの実施中に、pg-rex\_switchoverが異常終了した場合のクラスタ状態は不確定であり、データベースサービスが停止している可能性がある。この場合、元の状態への復旧は自動で実施されないため、クラスタ状態を確認し、手動復旧を試みること。
3. 起動確認はPostgreSQLやIPaddr2、Ping、STONITHなどの固有のリソースにしか確認を行わないため、Apacheなど新しくリソースを追加したとしてもその確認を行わない。
4. 両ノードの状態確認にネットワークの通信を用いるので、ツールが使用するLAN（D-LAN）切断時は、それ以外のLANが繋がっていても実行に失敗する。
5. PG-REXでインストールしたファイルのディレクトリ構成が2つのノードで同一であること。
6. アーカイブログを圧縮する場合、圧縮方式に対応した拡張子を付与しなければならない。
    サポートする圧縮方式はgzip(拡張子.gz)のみである。

::: {custom-style="First Paragraph"}
　
:::

推奨設定
--------

本節では、PG-REX運用時の推奨設定を示します。

1. データベースサービスが高負荷のときの影響を局所化するために、DBデータを配置するディスクとOSのインストールディスクは分けることを推奨する。
2.  RAIDを用いる際に、高負荷時の誤ったフェイルオーバ防止や、Primary故障時の高速なフェイルオーバを実現したい場合は、大きめのRAIDキャッシュ（2GB以上）を搭載することを推奨する。

    また、スループット性能よりもフェイルオーバ時間短縮を重視したい場合は、kernelパラメータのvm.dirty\_background\_bytesを、postgresql.confのshared\_buffers以下のサイズ、もしくは搭載されているRAIDキャッシュ以下のサイズに設定することを推奨する。

    以下はvm.dirty\_background\_bytesを1024MBに設定する際の例である。

    ::: {custom-style="First Paragraph"}
    　
    :::

  ------------------------------------------------------------------------
  [# vim /etc/sysctl.conf\
  vm.dirty_background_bytes=1073741824\
  # sysctl \-p]{custom-style="Verbatim Char"}

  ------------------------------------------------------------------------
